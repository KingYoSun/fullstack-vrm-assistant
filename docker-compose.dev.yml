name: fullstack-vrm-assistant-dev

x-mock-provider: &mock-provider
  image: ghcr.io/ealen/echo-server:latest
  restart: unless-stopped

services:
  backend:
    image: python:3.12-slim
    container_name: vrm-backend-dev
    working_dir: /workspace/backend
    command: >-
      sh -c "
        cd /workspace/backend &&
        if [ -f requirements.dev.txt ]; then
          pip install --no-cache-dir -r requirements.dev.txt;
        else
          echo 'requirements.dev.txt が見つかりません。依存を追加後に再実行してください。';
        fi &&
        if [ -f app/main.py ]; then
          uvicorn app.main:app --reload --host 0.0.0.0 --port ${BACKEND_PORT:-8000};
        else
          echo 'app/main.py が見つかりません。バックエンド初期化後に再起動してください。' &&
          tail -f /dev/null;
        fi
      "
    volumes:
      - ./backend:/workspace/backend
      - ./config:/workspace/config:ro
      - ./data:/data
    env_file:
      - .env
    environment:
      - PROVIDERS_CONFIG_PATH=/workspace/config/providers.yaml
      - PYTHONPATH=/workspace/backend
    ports:
      - "${BACKEND_PORT:-8000}:${BACKEND_PORT:-8000}"
    depends_on:
      - llm-mock
      - stt-mock
      - tts-mock
      - embedding-mock
      - postgres
    profiles:
      - dev

  frontend:
    image: node:20-bullseye
    container_name: vrm-frontend-dev
    working_dir: /workspace/frontend
    command: >-
      sh -c "
        cd /workspace/frontend &&
        corepack enable &&
        if [ -f package.json ]; then
          pnpm install --frozen-lockfile=false &&
          pnpm dev -- --host --port ${FRONTEND_PORT:-5173};
        else
          echo 'package.json が見つかりません。Vite+React 初期化後に再起動してください。' &&
          tail -f /dev/null;
        fi
      "
    volumes:
      - ./frontend:/workspace/frontend
      - frontend_node_modules:/workspace/frontend/node_modules
    env_file:
      - .env
    ports:
      - "${FRONTEND_PORT:-5173}:${FRONTEND_PORT:-5173}"
    depends_on:
      - backend
    profiles:
      - dev

  llm-mock:
    <<: *mock-provider
    container_name: vrm-llm-mock
    environment:
      - PORT=${LLM_PORT:-8000}
    ports:
      - "${LLM_PORT:-8000}:${LLM_PORT:-8000}"
    networks:
      default:
        aliases:
          - llm
    profiles:
      - dev

  stt-mock:
    <<: *mock-provider
    container_name: vrm-stt-mock
    environment:
      - PORT=${STT_PORT:-6006}
    ports:
      - "${STT_PORT:-6006}:${STT_PORT:-6006}"
    networks:
      default:
        aliases:
          - stt
    profiles:
      - dev

  tts-mock:
    <<: *mock-provider
    container_name: vrm-tts-mock
    environment:
      - PORT=${TTS_PORT:-7007}
    ports:
      - "${TTS_PORT:-7007}:${TTS_PORT:-7007}"
    networks:
      default:
        aliases:
          - tts
    profiles:
      - dev

  embedding-mock:
    <<: *mock-provider
    container_name: vrm-embedding-mock
    environment:
      - PORT=${EMBEDDING_PORT:-9000}
    ports:
      - "${EMBEDDING_PORT:-9000}:${EMBEDDING_PORT:-9000}"
    networks:
      default:
        aliases:
          - embedding
    profiles:
      - dev

  postgres:
    image: postgres:16-alpine
    container_name: vrm-postgres-dev
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-vrm}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-vrm_password}
      - POSTGRES_DB=${POSTGRES_DB:-vrm}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    profiles:
      - dev

volumes:
  frontend_node_modules:
  postgres_data:
