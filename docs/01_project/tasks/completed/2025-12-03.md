# 2025年12月03日

- README.md を新規作成し、リポジトリ概要・DGX Spark 前提の起動手順・構成・今後の改善項目を整理。
  - モデル配置やビルド手順、モック/開発プロファイルの起動方法をまとめ、関連ドキュメントへの導線を記載。
  - ディレクトリ構成と設定ファイルの役割を一覧化し、`config/providers.yaml` と `.env` の使い方を明示。
- docker-compose の backend/frontend を Dockerfile ベースに変更し、イメージビルド時に依存を取り込むようにした。
  - backend/frontend 用 Dockerfile と .dockerignore を追加し、ランタイムでの apt/pip/pnpm 実行を排除。
  - 本番 compose はビルド済みイメージを使用する構成にし、dev compose はホットリロード/preview 用の起動コマンドのみを指定。
  - README のビルド手順と `docker/` ディレクトリ説明を更新。
- docker compose を単一ファイルに集約し、プロファイルで dev/prod/mock を切り替える構成に統一。
  - backend-dev/frontend-dev を dev プロファイルでホットリロード起動できるよう追加し、llm/stt/tts/embedding/postgres も dev/prod 両方で動くよう profiles を整理。不要になった `docker-compose.dev.yml` を削除。
  - COMPOSE_PROFILES 前提の運用に合わせて `.env.default`、Makefile (`make dev`/`make dev-all`)、AGENTS/README/implementation ドキュメント類の起動手順を更新。
  - `COMPOSE_PROFILES=prod|dev docker compose config` で生成確認済み。
- フロントエンドのデフォルト VRM をローカルの `frontend/public/AliciaSolid.vrm` に切り替え、ネットワーク 404 で背景のみになる問題を解消。
- フロントエンドのデフォルト VRM 取得先が 404 となり画面が背景のみになる問題を修正。
  - three-vrm リポジトリの dev コミットに固定した VRM1 サンプルへデフォルト URL を差し替え、再度 404 になりにくいようにした。
  - Canvas 周りにエラーバウンダリを追加し、VRM ロード失敗時に原因メッセージと再試行ボタンを表示するようにした（ログにもエラーを記録）。
- フロントエンドの接続先を任意ドメインで使えるように変更。
  - WebSocket ベース URL を環境変数（`VITE_WS_BASE_URL` / `VITE_BACKEND_HOST` / `VITE_BACKEND_PORT` / `VITE_WS_PATH`）とページのロケーションから組み立てるようにし、デフォルトでアクセス元ホスト + port 8000 + `/ws/session` を選ぶようにした。
  - frontend コンテナの Dockerfile/compose にビルド引数を追加し、`.env.default` に新変数を追記。README に利用方法を反映。
- Backend WebSocket 依存解決時に `get_container()` 例外で落ちる問題を修正し、接続成功を確認。
  - HTTP/WS 依存を分離し、コンテナ取得を Pydantic モデル化させずに取得する形に整理。WebSocket ルートを WS 向け依存に付け替え。
- フロントエンドで WebSocket 接続後に Start Mic が `navigator.mediaDevices.getUserMedia` undefined で失敗する問題を修正。
  - secure context/非対応ブラウザを検知して Start ボタンを無効化し、原因をログ出力するようにした。
  - `navigator.getUserMedia` 系のフォールバックを追加し、未対応環境では明確なエラーメッセージを返すようにした。
- WebSocket 音声入力で ffmpeg デコードが失敗し、`audio backlog exceeded` が発生していた問題を修正。
  - 受信済みチャンク全体を ffmpeg でデコードし、フォーマットヒント（WebM/Ogg/WAV）を付けて逐次 PCM 差分を取り出すように変更。
  - 入力ドロップ時に PCM オフセットをリセットし、再デコードで進行状況がずれないようにした。
- ffmpeg デコードが途中のチャンクで `End of file` となり警告が連発するのを抑制。
  - EOF/Invalid data 系は無害として無視し、実質的なデコード失敗だけを 1 回だけ警告するようにした。
